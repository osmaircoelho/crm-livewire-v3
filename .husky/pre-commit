#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Rodar o phpstan
./vendor/bin/phpstan

if [ $? -ne 0 ]; then
    echo "Opa! Deu ruim aqui com PHPSTAN. Arrume antes de continuar... 😉";
    exit 1;
fi;

# rodar os testes
php artisan test --parallel

if [ $? -ne 0 ]; then
    echo "Opa! Deu ruim aqui com algum teste. Arrume antes de continuar... 😉";
    exit 1;
fi;

# Formatar cada arquivo alterado usando o Laravel Pint
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".php\{0,1\}$") || true
TOTAL_FILES=$(echo "$STAGED_FILES" | wc -l)
CURRENT=0

echo "📝 Formatando $TOTAL_FILES arquivos..."

for FILE in $STAGED_FILES
do
    CURRENT=$((CURRENT+1))
    printf "🔄 [%d/%d] Formatando %s..." "$CURRENT" "$TOTAL_FILES" "$FILE"

    ./vendor/bin/pint "${FILE}" > /dev/null 2>&1
    git add "${FILE}"

    printf "\r✅ [%d/%d] %s formatado\n" "$CURRENT" "$TOTAL_FILES" "$FILE"
done;

if [ "$TOTAL_FILES" -gt 0 ]; then
    echo "✨ Todos os arquivos foram formatados com sucesso!"
fi;

exit 0;
